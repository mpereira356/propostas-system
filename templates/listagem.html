{% extends "base.html" %}

{% block title %}Listagem de Propostas - Sistema de Propostas{% endblock %}

{% block extra_css %}
<style>
    .listagem-header {
        background-color: #16263D;
        color: #FFFFFF;
    }
    .listagem-header .btn-nova-importacao {
        background-color: #1F3A5F;
        border-color: #1F3A5F;
        color: #FFFFFF;
    }
    .listagem-header .btn-nova-importacao:hover {
        background-color: #274C77;
        border-color: #274C77;
        color: #FFFFFF;
    }
    .btn-filtrar {
        background-color: #1F3A5F;
        border-color: #1F3A5F;
        color: #FFFFFF;
    }
    .btn-filtrar:hover {
        background-color: #274C77;
        border-color: #274C77;
        color: #FFFFFF;
    }
    .badge-vencendo {
        background-color: #D97706;
        color: #FFFFFF;
    }
    .btn-action-view {
        background-color: #1F3A5F;
        border-color: #1F3A5F;
        color: #FFFFFF;
    }
    .btn-action-view:hover {
        background-color: #1a2f4d;
        border-color: #1a2f4d;
        color: #FFFFFF;
    }
    .btn-action-edit {
        background-color: #D97706;
        border-color: #D97706;
        color: #FFFFFF;
    }
    .btn-action-edit:hover {
        background-color: #bf6905;
        border-color: #bf6905;
        color: #FFFFFF;
    }
    .btn-action-delete {
        background-color: #B91C1C;
        border-color: #B91C1C;
        color: #FFFFFF;
    }
    .btn-action-delete:hover {
        background-color: #a01818;
        border-color: #a01818;
        color: #FFFFFF;
    }
    .btn-action-win {
        background-color: #15803D;
        border-color: #15803D;
        color: #FFFFFF;
    }
    .btn-action-win:hover {
        background-color: #126c34;
        border-color: #126c34;
        color: #FFFFFF;
    }
    .btn-action-negotiation {
        background-color: #1F3A5F;
        border-color: #1F3A5F;
        color: #FFFFFF;
    }
    .btn-action-negotiation:hover {
        background-color: #274C77;
        border-color: #274C77;
        color: #FFFFFF;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header listagem-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-ul"></i> Propostas Importadas
                </h4>
                <a href="{{ url_for('upload') }}" class="btn btn-nova-importacao btn-sm">
                    <i class="bi bi-plus-circle"></i> Nova Importação
                </a>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Total de propostas</p>
                                        <h4 class="mb-0">{{ total_propostas }}</h4>
                                    </div>
                                    <div class="fs-3 text-primary">
                                        <i class="bi bi-collection"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Propostas ganhas</p>
                                        <h4 class="mb-0 text-success">{{ total_ganhas }}</h4>
                                    </div>
                                    <div class="fs-3 text-success">
                                        <i class="bi bi-check-circle"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Propostas perdidas</p>
                                        <h4 class="mb-0 text-danger">{{ total_perdidas }}</h4>
                                    </div>
                                    <div class="fs-3 text-danger">
                                        <i class="bi bi-x-circle"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Propostas em aberto</p>
                                        <h4 class="mb-0 text-warning">{{ total_abertas }}</h4>
                                    </div>
                                    <div class="fs-3 text-warning">
                                        <i class="bi bi-hourglass-split"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="text-muted mb-1">Propostas vencidas</p>
                                        <h4 class="mb-0 text-danger">{{ total_vencidas_dashboard }}</h4>
                                    </div>
                                    <div class="fs-3 text-danger">
                                        <i class="bi bi-exclamation-triangle"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <form method="GET" class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label for="razao_social" class="form-label">Razão Social</label>
                        <input type="text" 
                               class="form-control" 
                               id="razao_social" 
                               name="razao_social" 
                               value="{{ filtros.razao_social }}"
                               placeholder="Digite a razão social">
                    </div>
                    <div class="col-md-3">
                        <label for="cnpj" class="form-label">CNPJ</label>
                        <input type="text" 
                               class="form-control" 
                               id="cnpj" 
                               name="cnpj" 
                               value="{{ filtros.cnpj }}"
                               placeholder="00.000.000/0000-00">
                    </div>
                    <div class="col-md-3">
                        <label for="id_proposta" class="form-label">ID da Proposta</label>
                        <input type="text" 
                               class="form-control" 
                               id="id_proposta" 
                               name="id_proposta" 
                               value="{{ filtros.id_proposta }}"
                               placeholder="BA.0000/0000">
                    </div>
                    <div class="col-md-2">
                        <label for="cod_vendedor" class="form-label">Cod Vendedor</label>
                        <input type="text" 
                               class="form-control" 
                               id="cod_vendedor" 
                               name="cod_vendedor" 
                               value="{{ filtros.cod_vendedor }}"
                               placeholder="016">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-filtrar w-100">
                            <i class="bi bi-search"></i> Filtrar
                        </button>
                    </div>
                </form>

                {% if filtros.razao_social or filtros.cnpj or filtros.id_proposta or filtros.cod_vendedor %}
                <div class="mb-3">
                    <a href="{{ url_for('listagem') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpar Filtros
                    </a>
                </div>
                {% endif %}

                <!-- Tabela de Propostas -->
                {% if grupos %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Proposta</th>
                                <th>Razão Social</th>
                                <th>CNPJ</th>
                                <th>Data Emissão</th>
                                <th>Data Vencimento</th>
                                <th>Cod Vendedor</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for grupo in grupos %}
                            {% set proposta = grupo.current %}
                            <tr class="{% if proposta.observacoes == 'Vencida' %}table-danger{% elif proposta.observacoes == 'Ganha' %}table-success{% else %}{% endif %}">
                                <td>
                                    <strong>{{ proposta.id_proposta or 'N/A' }}</strong>
                                    {% if grupo.versions %}
                                        <button class="btn btn-sm btn-outline-secondary ms-2 toggle-versoes"
                                                type="button"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#versoes-{{ proposta.id }}"
                                                aria-expanded="false"
                                                aria-controls="versoes-{{ proposta.id }}"
                                                title="Ver versões antigas">
                                            <i class="bi bi-caret-down-fill"></i>
                                        </button>
                                    {% endif %}
                                </td>
                                <td>{{ proposta.razao_social or 'Não informado' }}</td>
                                <td>{{ proposta.cnpj or 'N/A' }}</td>
                                <td>{{ proposta.data_emissao or 'N/A' }}</td>
                                <td>
                                    {{ proposta.data_vencimento.strftime('%d/%m/%Y') if proposta.data_vencimento else 'N/A' }}
                                </td>
                                <td>
                                    {% if proposta.cod_vendedor %}
                                        <strong>{{ proposta.cod_vendedor }}</strong>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('atualizar_cod', id=proposta.id) }}" class="d-flex gap-2">
                                            <input type="text" name="cod_vendedor" class="form-control form-control-sm" placeholder="cod">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">Salvar</button>
                                        </form>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if proposta.observacoes == 'Ganha' %}
                                        <span class="badge text-bg-success">Ganha</span>
                                    {% elif proposta.observacoes == 'Perdida' %}
                                        <span class="badge text-bg-danger">Perdida</span>
                                    {% elif proposta.observacoes == 'Vencida' %}
                                        <span class="badge text-bg-danger">Vencida</span>
                                    {% else %}
                                        <span class="badge badge-vencendo">Em negociação</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if proposta.observacoes != 'Vencida' %}
                                    <form method="POST" action="{{ url_for('atualizar_observacoes', id=proposta.id) }}" class="d-inline">
                                        <input type="hidden" name="observacoes" value="Em negociação">
                                        <button type="submit" class="btn btn-sm btn-action-negotiation" title="Em negociação">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('atualizar_observacoes', id=proposta.id) }}" class="d-inline">
                                        <input type="hidden" name="observacoes" value="Ganha">
                                        <button type="submit" class="btn btn-sm btn-action-win" title="Marcar como ganha">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('atualizar_observacoes', id=proposta.id) }}" class="d-inline">
                                        <input type="hidden" name="observacoes" value="Perdida">
                                        <button type="submit" class="btn btn-sm btn-action-delete" title="Marcar como perdida">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <a href="{{ url_for('detalhes', id=proposta.id) }}" 
                                       class="btn btn-sm btn-action-view"
                                       title="Ver detalhes">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('editar', id=proposta.id) }}"
                                       class="btn btn-sm btn-action-edit"
                                       title="Editar">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-action-delete"
                                            onclick="confirmarDelete({{ proposta.id }}, '{{ proposta.id_proposta }}')"
                                            title="Deletar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% if grupo.versions %}
                                {% for versao in grupo.versions %}
                                <tr class="collapse" id="versoes-{{ proposta.id }}">
                                    <td class="ps-4">
                                        <i class="bi bi-arrow-return-right me-2"></i>
                                        <strong>{{ versao.id_proposta or 'N/A' }}</strong>
                                    </td>
                                    <td>{{ versao.razao_social or 'Não informado' }}</td>
                                    <td>{{ versao.cnpj or 'N/A' }}</td>
                                    <td>{{ versao.data_emissao or 'N/A' }}</td>
                                    <td>
                                        {{ versao.data_vencimento.strftime('%d/%m/%Y') if versao.data_vencimento else 'N/A' }}
                                    </td>
                                    <td>
                                        {% if versao.cod_vendedor %}
                                            <strong>{{ versao.cod_vendedor }}</strong>
                                        {% else %}
                                            <form method="POST" action="{{ url_for('atualizar_cod', id=versao.id) }}" class="d-flex gap-2">
                                                <input type="text" name="cod_vendedor" class="form-control form-control-sm" placeholder="cod">
                                                <button type="submit" class="btn btn-sm btn-outline-primary">Salvar</button>
                                            </form>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if versao.observacoes == 'Ganha' %}
                                            <span class="badge text-bg-success">Ganha</span>
                                        {% elif versao.observacoes == 'Perdida' %}
                                            <span class="badge text-bg-danger">Perdida</span>
                                        {% elif versao.observacoes == 'Vencida' %}
                                            <span class="badge text-bg-danger">Vencida</span>
                                        {% else %}
                                            <span class="badge badge-vencendo">Em negociação</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if versao.observacoes != 'Vencida' %}
                                        <form method="POST" action="{{ url_for('atualizar_observacoes', id=versao.id) }}" class="d-inline">
                                            <input type="hidden" name="observacoes" value="Em negociação">
                                        <button type="submit" class="btn btn-sm btn-action-negotiation" title="Em negociação">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('atualizar_observacoes', id=versao.id) }}" class="d-inline">
                                        <input type="hidden" name="observacoes" value="Ganha">
                                            <button type="submit" class="btn btn-sm btn-action-win" title="Marcar como ganha">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('atualizar_observacoes', id=versao.id) }}" class="d-inline">
                                            <input type="hidden" name="observacoes" value="Perdida">
                                            <button type="submit" class="btn btn-sm btn-action-delete" title="Marcar como perdida">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        <a href="{{ url_for('detalhes', id=versao.id) }}" 
                                           class="btn btn-sm btn-action-view"
                                           title="Ver detalhes">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('editar', id=versao.id) }}"
                                           class="btn btn-sm btn-action-edit"
                                           title="Editar">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button type="button" 
                                                class="btn btn-sm btn-action-delete"
                                                onclick="confirmarDelete({{ versao.id }}, '{{ versao.id_proposta }}')"
                                                title="Deletar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <p class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        Total de propostas encontradas: <strong>{{ total_propostas }}</strong>
                        {% if total_vencidas is not none %}
                            | Vencidas: <strong class="text-danger">{{ total_vencidas }}</strong>
                        {% endif %}
                    </p>
                </div>
                {% else %}
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Nenhuma proposta encontrada.</strong>
                    <p class="mb-0">
                        {% if filtros.razao_social or filtros.cnpj or filtros.id_proposta %}
                            Tente ajustar os filtros ou 
                            <a href="{{ url_for('listagem') }}">limpar os filtros</a>.
                        {% else %}
                            <a href="{{ url_for('upload') }}">Importe sua primeira proposta</a> para começar.
                        {% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmação de deleção -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja deletar a proposta <strong id="propostaId"></strong>?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-info-circle"></i> Esta ação não pode ser desfeita.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Deletar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function confirmarDelete(id, idProposta) {
        document.getElementById('propostaId').textContent = idProposta;
        document.getElementById('deleteForm').action = '/deletar/' + id;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    document.querySelectorAll('.toggle-versoes').forEach((btn) => {
        const targetSelector = btn.getAttribute('data-bs-target');
        const target = document.querySelector(targetSelector);
        if (!target) return;

        target.addEventListener('shown.bs.collapse', () => {
            const icon = btn.querySelector('i');
            if (icon) {
                icon.classList.remove('bi-caret-down-fill');
                icon.classList.add('bi-caret-up-fill');
            }
        });

        target.addEventListener('hidden.bs.collapse', () => {
            const icon = btn.querySelector('i');
            if (icon) {
                icon.classList.remove('bi-caret-up-fill');
                icon.classList.add('bi-caret-down-fill');
            }
        });
    });
</script>
{% endblock %}
